---
## installs and sets up Mariadb
# - name: Add repository key to the system
#   apt_key: 
#     url: https://mariadb.org/mariadb_release_signing_key.asc
#     state: present
# - name: Install MariaDB repository
#   apt_repository: repo='deb https://mirror.kumi.systems/mariadb/repo/10.6/ubuntu focal main' state=present

- name: Install MariaDB Server
  apt: name=mariadb-server state=latest update_cache=yes


- name: Install python module
  apt: name=python3-pymysql state=latest

- name: Modify configuration file to listen on all interfaces
  lineinfile: dest=/etc/mysql/my.cnf regexp="^bind-address" line="bind-address=0.0.0.0"


- name: Modify configuration file to setup server ID
  lineinfile: dest=/etc/mysql/my.cnf regexp="^#server-id" line="server-id=1"
- name: Restart mysql service
  service: name=mysql state=restarted

- name: Create replication account
  mysql_user: name=repl host="%" password=lper priv="*.*:REPLICATION SLAVE" state=present login_unix_socket=/var/run/mysqld/mysqld.sock

- name: Create readwrite user
  mysql_user: name=rwuser host="%" password=adminpwd priv=*.*:SELECT,INSERT,UPDATE,DELETE,CREATE,DROP state=present login_unix_socket=/var/run/mysqld/mysqld.sock

# - name: Reset master binlog
#   command: /usr/bin/mysql -u root -e "RESET MASTER"

- name: Start MariaDB Service
  service: name=mysql state=started enabled=yes